<template>
  <FieldWrapper
    :label="label"
    :error="error"
    :class-name="`date-field ${className || ''} ${isOpen ? 'open' : ''}`"
    :required="required"
    component="div"
  >
    <span :ref="setRef" class="date-field__ref" />
    <VueDatePicker
      :menu-class-name="'date-field'"
      :clearable="clearable"
      :auto-apply="true"
      :range="range"
      :close-on-auto-apply="true"
      :config="{
        closeOnScroll
      }"
      :format="format"
      :hide-navigation="hideNavigation"
      :model-value="modelValue"
      :placeholder="placeholder || 'Select'"
      :min-date="minDate"
      :max-date="maxDate"
      :is-24="is24"
      :teleport="teleport"
      @update:model-value="changeHandler"
      @open="openHandler"
      @closed="closeHandler"
    >
      <template #input-icon>
        <Icon name="calendar" />
      </template>
      <template #month-year="{ month, year, months, years, updateMonthYear, handleMonthYearChange }">
        <SelectField
          :options="months.map((m: DateOpt) => ({ code: m.value, label: m.text }))"
          name="month"
          class-name="date-field__select month"
          :model-value="month"
          :searchable="false"
          :clearable="false"
          @update:model-value="updateMonth($event, updateMonthYear, year)"
        />

        <SelectField
          :options="yearsToOptions(years)"
          name="year"
          class-name="date-field__select year"
          :searchable="false"
          :clearable="false"
          :model-value="year"
          @update:model-value="updateYear($event, updateMonthYear, month)"
        />
        <button type="button" class="invert prev" @click="handleMonthYearChange(false)">
          <Icon name="angle-left" />
        </button>
        <button type="button" class="invert next" @click="handleMonthYearChange(true)">
          <Icon name="angle-right" />
        </button>
      </template>
    </VueDatePicker>
  </FieldWrapper>
</template>

<script lang="ts" setup>
import FieldWrapper from '../FieldWrapper/FieldWrapper.vue';
import Icon from '../../viewers/Icon/Icon.vue';
import SelectField from '../SelectField/SelectField.vue';
import { ref } from 'vue';
import getYear from 'date-fns/getYear';
import VueDatePicker from '@vuepic/vue-datepicker';

interface Props {
  clearable?: boolean;
  label?: string;
  error?: string;
  disabled?: boolean;
  className?: string;
  name: string;
  modelValue?: string | Date;
  range?: boolean;
  minDate?: Date | string;
  maxDate?: Date | string;
  required?: boolean;
  is24?: boolean;
  hideNavigation?: Array<'month' | 'year' | 'calendar' | 'time' | 'minutes' | 'hours' | 'seconds'>;
  format?: string;
  placeholder?: string;
  teleport?: boolean;
  closeOnScroll?: boolean;
}

interface DateOpt {
  value: string;
  text: string;
}

const wrapperRef = ref<unknown>(null);
defineExpose({ wrapperRef });

const setRef = (val: unknown) => {
  wrapperRef.value = val;
};
const props = withDefaults(defineProps<Props>(), {
  format: 'dd/MM/yyyy',
  hideNavigation: () => ['time'] as Array<'month' | 'year' | 'calendar' | 'time' | 'minutes' | 'hours' | 'seconds'>,
  is24: true,
});
const emit = defineEmits(['update:modelValue']);
const isOpen = ref<boolean>(false);
type UpdateMonthYear = (month: number, year: number) => void;

const updateMonth = (event: number, updateMonthYear: UpdateMonthYear, year: number) => {
  updateMonthYear(event, year);
};

const updateYear = (event: number, updateMonthYear: UpdateMonthYear, month: number) => {
  updateMonthYear(month, event);
};

const changeHandler = (date: Date | Date[]) => {
  emit(
    'update:modelValue',
    date instanceof Date ? date.toISOString() : date.map((currDate) => currDate.toISOString()),
    props.name
  );
};

const openHandler = () => {
  isOpen.value = true;
};

const closeHandler = () => {
  isOpen.value = false;
};

function yearsToOptions(years: { value: number; text: string }[]) {
  return years
    .filter((year: { value: number; text: string }) => {
      let isAvailable = true;

      if (props.minDate) {
        const minYear = getYear(new Date(props.minDate));
        isAvailable = year.value >= minYear;
      }

      if (props.maxDate && isAvailable) {
        const maxYear = getYear(new Date(props.maxDate));
        isAvailable = year.value <= maxYear;
      }

      return isAvailable;
    })
    .map((m) => ({ code: m.value, label: m.text }));
}
</script>
