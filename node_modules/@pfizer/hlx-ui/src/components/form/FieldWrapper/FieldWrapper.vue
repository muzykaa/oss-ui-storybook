<template>
  <component
    :is="component || 'label'"
    :class="`form-field ${className || ''} ${error?.length ? 'invalid' : ''} ${info?.length ? 'has-tooltip' : ''}`"
  >
    <div v-if="label" ref="setRef" class="form-field__label">
      {{ label }}
      <span v-if="required" class="form-field__asterisk"> * </span>
      <a v-if="info?.length && infoType === 'download'" :href="info" :download="info">
        <Icon class-name="form-field__info" name="info" />
      </a>
      <a v-else-if="info?.length && infoType === 'link'" :href="info" target="_blank">
        <Icon class-name="form-field__info" name="info" />
      </a>
      <template v-else-if="info?.length">
        <Icon class-name="form-field__info" name="info" @click.stop.prevent="changeShowTooltipHandler(true, $event)" />
      </template>
      <Popup
        v-if="info?.length || infoTitle?.length"
        :model-value="showTooltip"
        :title="infoTitle!"
        :position="tooltipPosition"
        hide-backdrop
        class-name="tooltip"
        @update:model-value="changeShowTooltipHandler"
      >
        <template #content>
          <div v-html="info" />
        </template>
      </Popup>
    </div>
    <slot />
    <span v-if="error" class="form-field__error">{{ error }}</span>
    <span v-if="description && !error" class="form-field__description">{{ description }}</span>
  </component>
</template>

<script lang="ts" setup>
import Icon from '../../viewers/Icon/Icon.vue';
import { ref } from 'vue';
import Popup from '../../viewers/Popup/Popup.vue';
import type { Position } from '../../../type/etc/position';
import { getElementPosition } from '../../../utils/dom';

interface Props {
  label?: string;
  error?: string;
  description?: string;
  className?: string;
  info?: string;
  infoTitle?: string;
  infoType?: 'default' | 'download' | 'link';
  component?: string;
  required?: boolean;
}

defineProps<Props>();
const wrapperRef = ref<unknown>(null);
defineExpose({ wrapperRef });

const setRef = (val: unknown) => {
  wrapperRef.value = val;
};

const showTooltip = ref<boolean>(false);
const tooltipPosition = ref<Position>({
  top: 0,
  left: 0,
});

const changeShowTooltipHandler = (newValue: boolean, event?: MouseEvent) => {
  if (event) {
    tooltipPosition.value = getElementPosition(event.target as HTMLElement);
  }

  showTooltip.value = newValue;
};
</script>
