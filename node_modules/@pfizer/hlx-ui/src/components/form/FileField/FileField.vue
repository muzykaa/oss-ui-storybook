<template>
  <FieldWrapper
    :label="label"
    :error="error"
    :info="info"
    :description="description"
    :class-name="`field file-field ${className || ''}  ${disabled ? 'disabled' : ''} ${isDragOver ? 'is-dragging' : ''}`"
    @dragover.prevent="dragOverHandler"
    @dragleave="dragLeaveHandler"
    @drop.prevent="dropFileHandler"
  >
    <span class="file-field__wrapper form-field__input">
      <input
        type="file"
        :disabled="disabled"
        class="file-field__input form-field__input"
        :placeholder="placeholder"
        :multiple="multiple"
        @change="changeHandler"
      />
      <span v-if="preview" data-testid="file-preview" class="file-field__placeholder">{{ preview }}</span>
      <Icon name="file" />
    </span>
  </FieldWrapper>
</template>

<script lang="ts" setup>
import FieldWrapper from '../FieldWrapper/FieldWrapper.vue';
import Icon from '../../viewers/Icon/Icon.vue';
import { computed, ref } from 'vue';

interface Props {
  label?: string;
  error?: string;
  disabled?: boolean;
  className?: string;
  name: string;
  modelValue?: string | string[] | File | FileList;
  placeholder?: string;
  info?: string;
  description?: string;
  multiple?: boolean;
}

const props = defineProps<Props>();
const isDragOver = ref<boolean>(false);
const emit = defineEmits(['update:modelValue']);

const dropFileHandler = (event: DragEvent) => {
  isDragOver.value = false;

  if (event.dataTransfer) {
    emmitUpdateValue(event.dataTransfer.files);
  }
};

const dragOverHandler = () => {
  isDragOver.value = true;
};

const dragLeaveHandler = () => {
  isDragOver.value = false;
};

const previewResolver = (value: unknown): string => {
  if (!value) {
    return props.placeholder || '';
  } else if (value instanceof File) {
    return value.name;
  }

  if (value instanceof FileList) {
    // eslint-disable-next-line no-param-reassign
    value = Array.from(value).map((file: File) => file.name) as unknown;
  }

  if ((value as unknown[]).map) {
    return (value as string[]).length ? (value as string[]).join(', ') : (props.placeholder as string);
  }

  return (props.modelValue || props.placeholder) as string;
};

const preview = computed(() => previewResolver(props.modelValue || props.placeholder));

const changeHandler = (event: Event) => {
  const target = event.target as HTMLInputElement;

  if (target.files) {
    emmitUpdateValue(target.files);
  }
};

const emmitUpdateValue = (fileList: FileList) => {
  const files = props.multiple ? fileList : fileList[0];

  emit('update:modelValue', files, props.name);
};
</script>
