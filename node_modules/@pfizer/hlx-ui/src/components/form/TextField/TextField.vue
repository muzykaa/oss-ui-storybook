<template>
  <FieldWrapper
    :label="label"
    :error="error"
    :info="info"
    :description="description"
    :class-name="
      `field text-field ${className || ''} ` +
      ` ${focused ? 'focus' : ''} ` +
      `${disabled ? 'disabled' : ''} ` +
      `${icon ? 'has-icon' : ''}` +
      `${prefix ? 'has-prefix' : ''}`
    "
  >
    <div :ref="setRef" class="text-field__wrapper">
      <Icon v-if="icon" :name="icon" />
      <span v-if="prefix" :ref="setPrefixtRef" class="text-field__prefix">
        {{ prefix }}
      </span>
      <vue-number
        v-if="number"
        :ref="setInputRef"
        v-model.lazy="value"
        v-bind="{
          decimal: '.',
          separator: ',',
          prefix: props.prefixNumber,
          precision: 2,
          placeholder: props.placeholder,
        }"
        :disabled="disabled"
        class="text-field__input form-field__input"
        @focus="focusHandler"
        @blur="blurHandler"
        @update:modelValue="changeHandler"
      />
      <input
        v-else
        :ref="setInputRef"
        v-maska:[maskOpts]
        type="text"
        :disabled="disabled"
        class="text-field__input form-field__input"
        :value="modelValue"
        :placeholder="placeholder"
        @focus="focusHandler"
        @blur="blurHandler"
        @change="changeHandler"
      />
    </div>
  </FieldWrapper>
</template>

<script lang="ts" setup>
import FieldWrapper from '../FieldWrapper/FieldWrapper.vue';
import { component as VueNumber } from '@coders-tm/vue-number-format';
import { ref, watch, onMounted } from 'vue';
import Icon from '../../viewers/Icon/Icon.vue';
import type { MaskaDetail } from 'maska';

interface Props {
  label?: string;
  error?: string;
  disabled?: boolean;
  className?: string;
  name: string;
  modelValue?: string;
  placeholder?: string;
  info?: string;
  description?: string;
  icon?: string;
  prefix?: string;
  mask?: string;
  number?: boolean;
  prefixNumber?: string;
}

const props = defineProps<Props>();
const emit = defineEmits(['update:modelValue']);
const focused = ref<boolean>(false);
const wrapperRef = ref<unknown>(null);
const inputRef = ref<HTMLInputElement | null>(null);
const prefixRef = ref<HTMLSpanElement | null>(null);

defineExpose({ wrapperRef });

const setRef = (val: unknown) => {
  wrapperRef.value = val;
};

const setInputRef = (val: unknown) => {
  inputRef.value = val as HTMLInputElement;
};

const setPrefixtRef = (val: unknown) => {
  prefixRef.value = val as HTMLSpanElement;
};

const value = ref<string | number>(props.modelValue || '');

const maskOpts = (props.mask
  ? {
      mask: (val: string) => {
        if (props.mask && props.mask.indexOf('@') > -1) {
          const newMask = new Array(val.length + 1).fill('@', 0, val.length + 1).join('');

          return props.mask?.replace(/@+/gis, newMask);
        }

        return props.mask;
      },
      reversed: true,
      tokens: {
        '@': { pattern: /[0-9-]/ },
      },
      onMaska: (detail: MaskaDetail) => emit('update:modelValue', detail.unmasked, props.name),
    }
  : null) as unknown as string;

const number = props.number
  ? {
      decimal: '.',
      separator: ',',
      prefix: props.prefixNumber,
      precision: 2,
    }
  : undefined;

const focusHandler = () => {
  focused.value = true;
};

const blurHandler = () => {
  focused.value = false;
};

const changeHandler = (event: unknown) => {
  const val = event instanceof Event ? (event.target as HTMLInputElement).value : event;
  emit('update:modelValue', val, props.name);
};

watch(props, (newProps) => {
  value.value = newProps.modelValue as string;
});

onMounted(() => {
  if(props.prefix) {
    const prefixWidth = (prefixRef.value as HTMLSpanElement).offsetWidth;
    (inputRef.value as HTMLInputElement).style.paddingLeft = `${prefixWidth + 25}px`
  }  
})
</script>
