<template>
  <FieldWrapper
    :label="label"
    :error="error"
    :required="required"
    :class-name="`select-field ${className || ''} ${isOpen ? 'focus' : ''} ${disabled ? 'disabled' : ''}`"
    component="div"
  >
    <div :ref="setRef" />
    <VSelect
      v-bind="$props"
      :ref="setSelectRef"
      label="label"
      :reduce="reduce"
      :options="options"
      :model-value="modelValue"
      :append-to-body="appendToBody"
      :searchable="searchable"
      @update:model-value="modelUpdateHandler"
      @open="openHandler"
      @close="closeHandler"
      @option:selecting="optionSelectingHandler"
    >
      <template v-if="!multiple" #selected-option-container="opt">
        {{ opt['option']['label'] }}
      </template>
      <template v-if="multiple && !showSelected" #selected-option-container>{{ '' }}</template>
      <template v-if="multiple" #search="{ attributes, events }">
        <div class="vs__selected-info">{{ modelValue?.length }} {{ selectedOptionsText }}</div>
        <input class="vs__search" v-bind="(attributes as unknown as object)" v-on="events" />
      </template>
    </VSelect>
  </FieldWrapper>
</template>

<script lang="ts" setup>
import FieldWrapper from '../FieldWrapper/FieldWrapper.vue';
import type { Option } from '../../../type/form/Option';
import { ref } from 'vue';
import VSelect from 'vue-select';
import type { VueSelectData } from 'vue-select'

interface Props {
  label?: string;
  error?: string;
  disabled?: boolean;
  className?: string;
  name: string;
  options: Option[];
  modelValue?: string;
  placeholder?: string;
  required?: boolean;
  clearable?: boolean;
  appendToBody?: boolean;
  closeOnBodyScroll?: boolean;
  searchable?: boolean;
  multiple?: boolean;
  selectedOptionsText?: string;
  showSelected?: boolean;
}

const wrapperRef = ref<unknown>(null);
const selectRef = ref<unknown>(null);
const isOpen = ref<boolean>(false);
defineExpose({ wrapperRef });

const setRef = (val: unknown) => {
  wrapperRef.value = val;
};
const setSelectRef = (val: unknown) => {
  selectRef.value = val;
};
const props = withDefaults(defineProps<Props>(), {
  selectedOptionsText: 'selected options',
});
const emit = defineEmits(['update:modelValue']);

const reduce = (opt: Option) => opt.code;

const modelUpdateHandler = (event: unknown) => {
  emit('update:modelValue', event, props.name);
};

const closeMenuHanlder = () => {
  (selectRef.value as VueSelectData).open = false;
}

const openHandler = () => {
  isOpen.value = true;

  if(props.closeOnBodyScroll) {
    document.addEventListener('scroll', closeMenuHanlder, { once: true });
  }  
};

const closeHandler = () => {  
  isOpen.value = false;

  if(props.closeOnBodyScroll) {
    document.removeEventListener('scroll', closeMenuHanlder);
  } 
};

const optionSelectingHandler = (option: Option) => {
  if (!props.multiple) {
    return;
  }

  const isExisting = (props.modelValue as unknown as string[])?.find((opt: string) => opt === option.code);
  if (!isExisting) {
    return;
  }

  const filteredValues = (props.modelValue as unknown as string[])?.filter((opt: string) => {
    return opt !== option.code;
  });

  emit('update:modelValue', filteredValues, props.name);
};
</script>

<style lang="scss">
@import './SelectField';
</style>
