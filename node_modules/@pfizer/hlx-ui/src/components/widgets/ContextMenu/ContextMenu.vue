<template>
  <button
    :class="['context-menu__btn', { show: isOpen, invert: mode === 'default', dropdown: mode === 'dropdown' }]"
    @click="btnClickHandler"
  >
    <slot>
      <Icon name="dots-vertical" />
    </slot>

    <slot v-if="mode === 'dropdown'" name="dropdown-icon">
      <Icon name="angle-down" class-name="dropdown-indicator" />
    </slot>
  </button>
  <Flyout v-model="isOpen" :position="position" :width="width" :class-name="`context-menu ${className || ''} ${mode}`">
    <template v-for="item in items" :key="item.key">
      <a
        v-if="item.url?.length"
        :href="item.disabled ? '#' : item.url"
        :class="['button invert context-menu__item', { disabled: item.disabled }]"
      >
        <Icon v-if="item.icon" :name="item.icon" />
        {{ item.title }}
      </a>
      <button
        v-else
        class="invert context-menu__item"
        :disabled="item.disabled"
        @click="itemClickHandler(item.key, $event)"
      >
        <Icon v-if="item.icon" :name="item.icon" />
        {{ item.title }}
      </button>
    </template>
  </Flyout>
</template>

<script lang="ts" setup>
import Icon from '../../viewers/Icon/Icon.vue';
import Flyout from '../../viewers/Flyout/Flyout.vue';
import { ref } from 'vue';
import type { Position } from '../../../type/etc/position';
import type { MenuItem } from '../../../type/etc/MenuItem';

interface Props {
  items: MenuItem[];
  context?: unknown;
  className?: string;
  mode: 'default' | 'dropdown';
  minWidth?: number;
}

const props = withDefaults(defineProps<Props>(), {
  mode: 'default',
  minWidth: 0,
});
const emit = defineEmits(['action']);
const isOpen = ref<boolean>(false);
const width = ref<string | undefined>(undefined);
const position = ref<Position>({
  top: 0,
  left: 0,
});

const btnClickHandler = (event: MouseEvent) => {
  event.preventDefault();

  const isDropDown = props.mode === 'dropdown';
  const rect = (event.currentTarget as HTMLElement).getBoundingClientRect();
  position.value = {
    top: isDropDown ? rect.top + rect.height : rect.top,
    left: rect.left,
  };

  if (isDropDown) {
    width.value = `${rect.width}`;
  }

  isOpen.value = !isOpen.value;
};

const itemClickHandler = (key: string, event: MouseEvent) =>
  setTimeout(() => {
    emit('action', key, props.context, event);
  }, 100);
</script>

<style lang="scss" scoped>
.context-menu__btn {
  min-width: #{v-bind('minWidth')}px;
  align-items: center;
}
</style>
